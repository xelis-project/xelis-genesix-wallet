name: Build Windows

on:
  workflow_dispatch:
    inputs:
      version:
        description: Build version when not running from a tag (e.g. 0.1.3-test)
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: build-windows-${{ github.ref }}
  cancel-in-progress: true

env:
  FRB_CODEGEN_VERSION: 2.11.1

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Resolve build version
        shell: pwsh
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          $version = ""
          if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace '^refs/tags/v', ''
          } elseif (-not [string]::IsNullOrWhiteSpace($env:INPUT_VERSION)) {
            $version = $env:INPUT_VERSION
          }

          if ([string]::IsNullOrWhiteSpace($version)) {
            Write-Error "Build version is required for workflow_dispatch when not building from a tag (refs/tags/v*)."
            exit 1
          }

          "BUILD_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Install Flutter Rust bridge
        run: cargo install flutter_rust_bridge_codegen --version $env:FRB_CODEGEN_VERSION --locked

      - name: Install dependencies
        run: flutter pub get

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Generate Dart code
        run: dart run build_runner build -d

      - name: Build Windows app
        run: flutter build windows --release

      - name: Download VC++ Redistributable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "windows/installer/deps" | Out-Null
          $redistPath = "windows/installer/deps/vc_redist.x64.exe"
          Invoke-WebRequest "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile $redistPath
          if (-not (Test-Path $redistPath)) {
            Write-Error "Failed to download vc_redist.x64.exe"
            exit 1
          }

      - name: Create release ZIP
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist/windows" | Out-Null
          $zipPath = "dist/windows/genesix-windows-x64-v$env:BUILD_VERSION.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath $zipPath

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build Inno Setup installer
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist/windows" | Out-Null
          $releaseDir = (Resolve-Path "build/windows/x64/runner/Release").Path
          $outputDir = (Resolve-Path "dist/windows").Path
          $issPath = (Resolve-Path "windows/installer/genesix.iss").Path
          $redistExe = (Resolve-Path "windows/installer/deps/vc_redist.x64.exe").Path

          $iscc = Join-Path ${env:ProgramFiles(x86)} "Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            $iscc = Join-Path $env:ProgramFiles "Inno Setup 6\ISCC.exe"
          }
          if (-not (Test-Path $iscc)) {
            Write-Error "ISCC.exe not found after installing Inno Setup."
            exit 1
          }

          & $iscc $issPath "/DMyAppVersion=$env:BUILD_VERSION" "/DReleaseDir=$releaseDir" "/DOutputDir=$outputDir" "/DRedistExe=$redistExe"

      - name: Archive ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: genesix-windows-release-zip-v${{ env.BUILD_VERSION }}
          path: dist/windows/*.zip
          if-no-files-found: error

      - name: Archive installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: genesix-windows-installer-${{ env.BUILD_VERSION }}
          path: dist/windows/*.exe
          if-no-files-found: error
