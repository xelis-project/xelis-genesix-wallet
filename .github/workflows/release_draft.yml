name: Draft Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: Existing release version without leading v (e.g. 0.1.3)
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: release-draft-${{ github.ref }}
  cancel-in-progress: true

env:
  FRB_CODEGEN_VERSION: 2.11.1

jobs:
  resolve-version:
    name: Resolve Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve version and tag
        id: resolve
        shell: bash
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ -n "${INPUT_VERSION:-}" ]]; then
            VERSION="${INPUT_VERSION}"
          else
            echo "Error: version input is required for workflow_dispatch."
            exit 1
          fi

          TAG="v${VERSION}"

          git fetch --tags --force
          if ! git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Error: tag ${TAG} does not exist in repository."
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: resolve-version
    env:
      BUILD_VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-version.outputs.tag }}

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Flutter Rust bridge
        run: cargo install flutter_rust_bridge_codegen --version "$FRB_CODEGEN_VERSION" --locked

      - name: Install dependencies
        run: flutter pub get

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Generate Dart code
        run: dart run build_runner build -d

      - name: Build Android APKs (arm64-v8a + armeabi-v7a)
        run: flutter build apk --release --target-platform android-arm64,android-arm --split-per-abi

      - name: Rename APKs for end users
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/android

          ARM64_SRC="build/app/outputs/flutter-apk/app-arm64-v8a-release.apk"
          ARMV7_SRC="build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk"

          if [[ ! -f "$ARM64_SRC" ]]; then
            echo "Missing APK: $ARM64_SRC"
            exit 1
          fi
          if [[ ! -f "$ARMV7_SRC" ]]; then
            echo "Missing APK: $ARMV7_SRC"
            exit 1
          fi

          cp "$ARM64_SRC" "dist/android/genesix-android-${BUILD_VERSION}-64bit-arm.apk"
          cp "$ARMV7_SRC" "dist/android/genesix-android-${BUILD_VERSION}-32bit-arm.apk"

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-android-${{ env.BUILD_VERSION }}
          path: dist/android/*.apk
          if-no-files-found: error

  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    needs: resolve-version
    env:
      BUILD_VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-version.outputs.tag }}

      - name: Update packages
        run: sudo apt-get update -y

      - name: Install system libraries
        run: sudo apt-get install -y clang cmake git ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Flutter Rust bridge
        run: cargo install flutter_rust_bridge_codegen --version "$FRB_CODEGEN_VERSION" --locked

      - name: Install dependencies
        run: flutter pub get

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Generate Dart code
        run: dart run build_runner build -d

      - name: Build Linux app
        run: flutter build linux --release

      - name: Package Linux archive
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/linux
          tar -C build/linux/x64/release -czf "dist/linux/genesix-linux-${BUILD_VERSION}-x64.tar.gz" bundle

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-${{ env.BUILD_VERSION }}
          path: dist/linux/*.tar.gz
          if-no-files-found: error

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: resolve-version
    env:
      BUILD_VERSION: ${{ needs.resolve-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-version.outputs.tag }}

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Flutter Rust bridge
        run: cargo install flutter_rust_bridge_codegen --version $env:FRB_CODEGEN_VERSION --locked

      - name: Install dependencies
        run: flutter pub get

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Generate Dart code
        run: dart run build_runner build -d

      - name: Build Windows app
        run: flutter build windows --release

      - name: Download VC++ Redistributable
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "windows/installer/deps" | Out-Null
          $redistPath = "windows/installer/deps/vc_redist.x64.exe"
          Invoke-WebRequest "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile $redistPath
          if (-not (Test-Path $redistPath)) {
            Write-Error "Failed to download vc_redist.x64.exe"
            exit 1
          }

      - name: Create release ZIP
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist/windows" | Out-Null
          $zipPath = "dist/windows/genesix-windows-x64-v$env:BUILD_VERSION.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath $zipPath

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build Inno Setup installer
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist/windows" | Out-Null
          $releaseDir = (Resolve-Path "build/windows/x64/runner/Release").Path
          $outputDir = (Resolve-Path "dist/windows").Path
          $issPath = (Resolve-Path "windows/installer/genesix.iss").Path
          $redistExe = (Resolve-Path "windows/installer/deps/vc_redist.x64.exe").Path

          $iscc = Join-Path ${env:ProgramFiles(x86)} "Inno Setup 6\ISCC.exe"
          if (-not (Test-Path $iscc)) {
            $iscc = Join-Path $env:ProgramFiles "Inno Setup 6\ISCC.exe"
          }
          if (-not (Test-Path $iscc)) {
            Write-Error "ISCC.exe not found after installing Inno Setup."
            exit 1
          }

          & $iscc $issPath "/DMyAppVersion=$env:BUILD_VERSION" "/DReleaseDir=$releaseDir" "/DOutputDir=$outputDir" "/DRedistExe=$redistExe"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-${{ env.BUILD_VERSION }}
          path: |
            dist/windows/*.zip
            dist/windows/*.exe
          if-no-files-found: error

  draft-release:
    name: Draft Release
    runs-on: ubuntu-latest
    needs:
      - resolve-version
      - build-android
      - build-linux
      - build-windows
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.resolve-version.outputs.tag }}

      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: release-*-${{ needs.resolve-version.outputs.version }}
          merge-multiple: true

      - name: Verify expected assets
        shell: bash
        env:
          VERSION: ${{ needs.resolve-version.outputs.version }}
        run: |
          set -euo pipefail
          expected=(
            "release-assets/genesix-android-${VERSION}-64bit-arm.apk"
            "release-assets/genesix-android-${VERSION}-32bit-arm.apk"
            "release-assets/genesix-linux-${VERSION}-x64.tar.gz"
            "release-assets/genesix-windows-x64-v${VERSION}.zip"
            "release-assets/genesix-windows-x86_64-v${VERSION}.exe"
          )

          for file in "${expected[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "Missing expected asset: $file"
              exit 1
            fi
          done

      - name: Generate release body from template
        shell: bash
        env:
          VERSION: ${{ needs.resolve-version.outputs.version }}
          TAG: ${{ needs.resolve-version.outputs.tag }}
        run: |
          set -euo pipefail
          DATE_UTC="$(date -u +"%Y-%m-%d %H:%M UTC")"
          git fetch --tags --force
          PREV_TAG="$(git tag --sort=-v:refname | grep -Fvx "$TAG" | head -n1 || true)"
          if [[ -n "$PREV_TAG" ]]; then
            CHANGELOG_RANGE="${PREV_TAG#v}...${VERSION}"
            FULL_CHANGELOG_LINK="[${CHANGELOG_RANGE}](https://github.com/xelis-project/xelis-genesix-wallet/compare/${CHANGELOG_RANGE})"
          else
            FULL_CHANGELOG_LINK="N/A (first tagged release)"
          fi

          cp .github/release_template.md release_body.md
          sed -i "s/{{VERSION}}/${VERSION}/g" release_body.md
          sed -i "s/{{TAG}}/${TAG}/g" release_body.md
          ESCAPED_CHANGELOG_LINK="$(printf '%s' "$FULL_CHANGELOG_LINK" | sed -e 's/[\/&]/\\&/g')"
          sed -i "s/{{FULL_CHANGELOG_LINK}}/${ESCAPED_CHANGELOG_LINK}/g" release_body.md
          sed -i "s/{{DATE_UTC}}/${DATE_UTC}/g" release_body.md

      - name: Create or update draft release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve-version.outputs.tag }}
          name: âœ¨ Genesix Wallet Release ${{ needs.resolve-version.outputs.version }}
          draft: true
          prerelease: false
          body_path: release_body.md
          files: |
            release-assets/genesix-android-${{ needs.resolve-version.outputs.version }}-64bit-arm.apk
            release-assets/genesix-android-${{ needs.resolve-version.outputs.version }}-32bit-arm.apk
            release-assets/genesix-linux-${{ needs.resolve-version.outputs.version }}-x64.tar.gz
            release-assets/genesix-windows-x64-v${{ needs.resolve-version.outputs.version }}.zip
            release-assets/genesix-windows-x86_64-v${{ needs.resolve-version.outputs.version }}.exe
          fail_on_unmatched_files: true
