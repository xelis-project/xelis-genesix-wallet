name: Build Linux

on:
  workflow_dispatch:
    inputs:
      version:
        description: Build version when not running from a tag (e.g. 0.1.3-test)
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: build-linux-${{ github.ref }}
  cancel-in-progress: true

env:
  FRB_CODEGEN_VERSION: 2.11.1

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update packages
        run: sudo apt-get update -y

      - name: Install system libraries
        run: sudo apt-get install -y clang cmake git ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Resolve build version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          if [[ "${GITHUB_REF:-}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ -n "${INPUT_VERSION:-}" ]]; then
            VERSION="${INPUT_VERSION}"
          else
            echo "Error: build version is required for workflow_dispatch when not building from a tag (refs/tags/v*)."
            exit 1
          fi
          echo "BUILD_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Install Flutter Rust bridge
        run: cargo install flutter_rust_bridge_codegen --version "$FRB_CODEGEN_VERSION" --locked

      - name: Install dependencies
        run: flutter pub get

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Generate Dart code
        run: dart run build_runner build -d

      - name: Build Linux app
        run: flutter build linux --release

      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: genesix-linux-${{ env.BUILD_VERSION }}
          path: build/linux/x64/release/bundle
          if-no-files-found: error
