name: CI

on:
  workflow_call:
    inputs:
      dart_analyze_args:
        description: Additional arguments forwarded to dart analyze
        required: false
        default: ""
        type: string

permissions:
  contents: read

env:
  FRB_CODEGEN_VERSION: 2.11.1

jobs:
  dart-analyze:
    name: Dart Analyze
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install Flutter Rust bridge codegen
        run: cargo install flutter_rust_bridge_codegen --version "$FRB_CODEGEN_VERSION" --locked

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Generate Dart code
        run: dart run build_runner build -d

      - name: Dart analyze
        shell: bash
        run: |
          set -euo pipefail
          backup=""
          if [[ -f analysis_options.yaml ]]; then
            backup="$(mktemp)"
            cp analysis_options.yaml "$backup"
          fi

          cleanup() {
            if [[ -n "$backup" ]]; then
              cp "$backup" analysis_options.yaml
              rm -f "$backup"
            else
              rm -f analysis_options.yaml
            fi
          }
          trap cleanup EXIT

          cp analysis_options_ci.yaml analysis_options.yaml
          dart analyze ${{ inputs.dart_analyze_args }}

  rust-check:
    name: Rust Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Install Flutter Rust bridge codegen
        run: cargo install flutter_rust_bridge_codegen --version "$FRB_CODEGEN_VERSION" --locked

      - name: Generate bridge code
        run: flutter_rust_bridge_codegen generate

      - name: Cargo check
        working-directory: rust
        run: cargo check
